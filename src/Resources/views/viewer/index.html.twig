{% extends '@LogViewer/base.html.twig' %}

{% block stylesheets %}
    <link href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-ui-dist@1.13.2/jquery-ui.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
    
    
    <style>
        .toggle-checkbox:checked {
            @apply: right-0 border-green-400;
            right: 0;
            border-color: #68D391;
        }
        .toggle-checkbox:checked + .toggle-label {
            @apply: bg-green-400;
            background-color: #68D391;
        }
        
        td {
          	max-width:50px;
          	white-space: nowrap;
          	overflow: hidden;
          	text-overflow: ellipsis;
        }
        
        .redClass {
        	background-color: #ff05053b !important;
        }
        
        .yellowClass {
        	background-color: #f1cc003b !important;
        }
    </style>
{% endblock %}
{% block javascripts %}

    <script src="https://momentjs.com/downloads/moment.min.js" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.1/dist/jquery.min.js" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/datatables.net@1.13.5/js/jquery.dataTables.min.js" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-ui-dist@1.13.2/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <script type="text/javascript">
    
    	$(document).ready(function() {
        	const logsTable = $('#logsTable');
        	const groupsConfig = logsTable.data('groups-config');
        	
        	const btnFilter = $('#apply-filter');
        	const dateFilterFromInput = $('#date-filter-from');
        	const dateFilterToInput = $('#date-filter-to');
        	const fileFilterSelect = $('#file-filter');
        	const levelFilterSelect = $('#level-filter');
        	const toggleCase = $('#toggle-case');
        	const selectColumnField = $('#select-column-field');
        	
        	selectColumnField.select2({
			    closeOnSelect: false,
			    width: 'style'
			});
			
			selectColumnField.on('select2:opening select2:closing', ( event ) => {
    			var $searchfield = $(this).parent().find('.select2-search__field');
    			$searchfield.prop('disabled', true);
			});
			
			selectColumnField.on('select2:unselecting', (e) => { 
  				selectColumnField.on('select2:opening', (ev) => {
    				ev.preventDefault();
    				selectColumnField.off('select2:opening');
  				});
			});
			
        	const textFormat = (value) => { return value; }
        	const jsonFormat = (value) => {
        		let formattedValue = JSON.parse(value);
        		if (typeof formattedValue === 'object' && !Array.isArray(formattedValue)) {
        			return '<pre>' + JSON.stringify(value) + '</pre>';
        		}
        		return '<pre>' + formattedValue + '</pre>';
        	}
        
        	const format = (value, type) => {
        		switch (type) {
        			case 'json': 
        				return jsonFormat(value);
        			case 'text':
        			default: 
        				return textFormat(value);
        		}
        	}
        	
        	const urlParams = {};
        	
        	if(new URLSearchParams(window.location.search).has('level')) {
        		urlParams.level = new URLSearchParams(window.location.search).get('level');
        		urlParams.dateFilterFrom = new Date();
        	}
        	
        	const columnVisible = selectColumnField.select2('data').map(v => v.id);
        	
        	const datatableOptions = {
        		scrollX: true,
        		processing: true,
        		serverSide: false,
        		deferLoading: 0,
        		search: {
        			caseInsensitive: true
        		},
        		asStripeClasses: [ '' ],
        		ajax: {
        			url: `${logsTable.data('remote-url')}?` + new URLSearchParams(urlParams),
        			dataSrc: '',
        			dataType: "json",
        			error: (xhr, error, thrown) => console.log(error)
        		},
        		language: {
        			processing: '<i class="fas fa-spinner fa-spin fa-3x fa-fw"></i><span class="sr-only">Loading...</span> '
        		},
        		order: [[0, "desc"]],
        		columnDefs: [
        			{ targets: "no-sort", orderable: false },
        			{ targets: "_all", className: "border border-gray-400" },
        			{ targets: 0, visible: columnVisible.includes('0'), className: "border border-gray-400 whitespace-nowrap" },
        			{ targets: 1, visible: columnVisible.includes('1')},
        			{ targets: 2, visible: columnVisible.includes('2')},
        			{ targets: 3, visible: columnVisible.includes('3')},
        			{ targets: 4, visible: columnVisible.includes('4')},
        			{ targets: 5, visible: columnVisible.includes('5')}
        		],
        		columns: Object.keys(groupsConfig).map((groupName) => ({
    				data: groupName,
    				width: groupsConfig[groupName].width,
    				render: groupsConfig[groupName].type === 'date' ? DataTable.render.datetime('DD-MM-YYYY HH:mm:ss', 'it') : (value) => format(value, groupsConfig[groupName].type)
            	})),
            	createdRow: function( row, data, dataIndex){
            		if(data.level === 'ERROR' || data.level === 'CRITICAL' ) {
            			$(row).addClass('redClass');
            		} else if(data.level === 'WARNING') {
            			$(row).addClass('yellowClass');
            		}
            	}
        	};
        	
        	// Init Table
        	const logsDataTable = logsTable.DataTable(datatableOptions);
        	
        	
        	// On change column visible
        	selectColumnField.on('select2:select select2:unselect', function(e) {
        		const obj = e.params.data || e.params.args.data;
        		logsDataTable.column(Number(obj.id)).visible(obj.selected);
  			});
        	
        	
        	//logsDataTable.column(2).visible(false);
        	
        	// Click on row
        	$('#logsTable tbody').on('click', 'td', function () {
        		var data = logsDataTable.cell( this ).data();
        		
        		var newDiv = $(document.createElement('div')); 
				newDiv.html(data);
				newDiv.dialog({
  					width: $(window).width() * 0.8,
  					height: $(window).height() * 0.8,
  					modal: true
				});
    		} );
        
        	/* Apply filters */
        	btnFilter.on('click', function() {
        
        		if (dateFilterFromInput.value !== '') {
		        	url += '?dateFilterFrom=' + dateFilterFromInput.value;
		        }
		        	
		        if (dateFilterToInput.value !== '') {
		        	url += '&dateFilterTo=' + dateFilterToInput.value;
		        }
		        	
        		url += '&level=' + levelFilterSelect.value;
        
        		logsDataTable.ajax.url(url).load();
        	});
        });
    </script>
    
{% endblock %}

{% block body %}
<div class="w-full mx-auto pt-20">

    <div class="w-full px-4 md:px-0 md:mt-8 mb-16 text-gray-800 leading-normal">

        {% include "@LogViewer/viewer/filters.html.twig" %}

        <div class="w-full px-4 md:px-0 mb-16 text-gray-800 leading-normal">

            <div class="flex flex-wrap">
                <div class="w-full p-3">
                
                    <!--Log Table-->
                    <div class="bg-white border rounded shadow p-2 text-sm">
                    
                        <table
                                id="logsTable"
                                class="display nowrap"
                                style="width: 100%;"
                                data-page-length="10"
                                data-remote-url="{{ path('kira_log_viewer.viewer.ajax') }}"
                                data-columns-names="{{ groups|keys|json_encode }}"
                                data-groups-config="{{ groups|json_encode }}"
                        >
                            <thead>
                                <tr>
                                    {% for key in groups|keys %}
                                    <th>{{ key|capitalize }}</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                       </table>
                    </div>
                    <!--/Log Table-->
                </div>
            </div>

    </div>

</div>
{% endblock %}

{% block footer %}
{% endblock %}